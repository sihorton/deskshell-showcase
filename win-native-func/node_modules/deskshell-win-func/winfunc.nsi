; Script generated by the HM NIS Edit Script Wizard.

; HM NIS Edit Wizard helper defines
!define PRODUCT_NAME "Deskshell Windows Functions"
!define PRODUCT_VERSION "1.0"
!define PRODUCT_PUBLISHER "deskshell.org"
!define PRODUCT_WEB_SITE "http://deskshell.org/"
!define PRODUCT_DIR_REGKEY "Software\Microsoft\Windows\CurrentVersion\App Paths\AppMainExe.exe"

!include "Utf8Converter.nsh"
; MUI 1.67 compatible ------
!include "MUI.nsh"

; MUI Settings
!define MUI_ABORTWARNING
!define MUI_ICON "${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"

; Welcome page
;!insertmacro MUI_PAGE_WELCOME
; License page
;!insertmacro MUI_PAGE_LICENSE "c:\path\to\licence\YourSoftwareLicence.txt"
; Directory page
;!insertmacro MUI_PAGE_DIRECTORY
; Instfiles page
;!insertmacro MUI_PAGE_INSTFILES
; Finish page
;!define MUI_FINISHPAGE_RUN "$INSTDIR\AppMainExe.exe"
;!insertmacro MUI_PAGE_FINISH

; Language files
!insertmacro MUI_LANGUAGE "English"

; MUI end ------

!include nsDialogs.nsh
!include FileFunc.nsh
RequestExecutionLevel user
ShowInstDetails hide
ShowUnInstDetails hide
AutoCloseWindow true

Name "${PRODUCT_NAME} ${PRODUCT_VERSION}"
OutFile "winfunc.exe"
;InstallDir "$PROGRAMFILES\My application"
;InstallDirRegKey HKLM "${PRODUCT_DIR_REGKEY}" ""
ShowInstDetails hide
Function .onInit
    Var /GLOBAL OutPath

    ${GetOptions} $CMDLINE "/out" $OutPath
    StrCmp $OutPath "" defaultPath carryon1
defaultPath:
    Push "$EXEPATH"
    Call GetParent
    Pop $OutPath

    StrCpy $OutPath "$OutPath\out.txt"
carryon1:

    ${GetOptions} $CMDLINE "/fn" $2
    StrCmp $2 "filePicker" execFilePicker tryAgain1
execFilePicker:
    Call filePicker
    Quit
tryAgain1:
    StrCmp $2 "folderPicker" execFolderPicker tryAgain1
execFolderPicker:
    Call folderPicker
    Quit

    MessageBox MB_OK 'Unknown Function "$2"'

Quit
FunctionEnd

Function filePicker
    Var /GLOBAL SelectedFile
    Var /GLOBAL SelectedFileUTF8
    Var /GLOBAL OpenSave
    Var /GLOBAL Folder
    Var /GLOBAL Filter

    ${GetOptions} $CMDLINE "/filter" $Filter
    ${GetOptions} $CMDLINE "/folder" $Folder
    ${GetOptions} $CMDLINE "/opensave" $OpenSave
    StrCmp $OpenSave "" provideDefault carryon1
provideDefault:
    StrCpy $OpenSave "open"
carryon1:

    nsDialogs::SelectFileDialog $OpenSave $Folder "$Filter"
    Pop $SelectedFile

    ;MessageBox MB_ICONINFORMATION|MB_OK "$SelectedFile"
    ${AnsiToUtf8} $SelectedFile $SelectedFileUTF8
    FileOpen $5 "$OutPath" w
    FileWrite $5 '$SelectedFileUTF8'
    FileClose $5
FunctionEnd

Function folderPicker
    Var /GLOBAL Title

    ${GetOptions} $CMDLINE "/title" $Title
    ${GetOptions} $CMDLINE "/folder" $Folder

    nsDialogs::SelectFolderDialog $Title $Folder
    Pop $SelectedFile

    ;MessageBox MB_ICONINFORMATION|MB_OK "$SelectedFile"
    ${AnsiToUtf8} $SelectedFile $SelectedFileUTF8
    FileOpen $5 "$OutPath" w
    FileWrite $5 '$SelectedFileUTF8'
    FileClose $5
FunctionEnd

Section "MainSection" SEC01
SectionEnd




Function GetParent

  Exch $R0
  Push $R1
  Push $R2
  Push $R3

  StrCpy $R1 0
  StrLen $R2 $R0

  loop:
    IntOp $R1 $R1 + 1
    IntCmp $R1 $R2 get 0 get
    StrCpy $R3 $R0 1 -$R1
    StrCmp $R3 "\" get
  Goto loop

  get:
    StrCpy $R0 $R0 -$R1

    Pop $R3
    Pop $R2
    Pop $R1
    Exch $R0

FunctionEnd